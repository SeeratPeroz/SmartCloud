{% extends 'base.html' %}
{% load static %}

{% block title %}Patienten — Medien{% endblock %}

{% block extra_head %}
<!-- Import map so example modules can resolve "three" -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.158.0/build/three.module.js"
  }
}
</script>

<link rel="stylesheet" href="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.css">
<link rel="stylesheet" href="https://uicdn.toast.com/tui-color-picker/latest/tui-color-picker.css">
<style>
  .img-thumb{cursor:zoom-in}

  /* Overlay controls for the STL viewer (always visible) */
  .stl-controls{
    position:absolute;top:12px;right:12px;z-index:5;
    background:rgba(255,255,255,.95);border:1px solid #dee2e6;border-radius:12px;
    padding:10px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    box-shadow:0 6px 18px rgba(0,0,0,.25)
  }
  .stl-controls label{font-size:.8rem;color:#495057;margin:0}
  .stl-controls .color{
    appearance:none;width:36px;height:28px;border:1px solid #ced4da;border-radius:6px;padding:0;cursor:pointer
  }
  .stl-controls input[type="range"]{width:140px}
  .stl-controls .check{display:flex;align-items:center;gap:.35rem;font-size:.85rem;color:#495057}

  /* Comments drawer/backdrop */
  .comments-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1064;opacity:0;pointer-events:none;transition:opacity .2s}
  .comments-backdrop.show{opacity:1;pointer-events:auto}
  .comments-drawer{position:fixed;top:0;right:-390px;width:380px;height:100vh;background:#fff;z-index:1066;box-shadow:-8px 0 24px rgba(0,0,0,.15);display:flex;flex-direction:column;transition:right .25s}
  .comments-drawer.open{right:0}
  .comments-drawer .drawer-header{padding:.75rem 1rem;border-bottom:1px solid #e9ecef;display:flex;align-items:center;justify-content:space-between}
  .comments-drawer .drawer-body{padding:.75rem .75rem 0;overflow-y:auto;flex:1}
  .comments-drawer .drawer-footer{border-top:1px solid #e9ecef;padding:.75rem}

  .msg{display:flex;gap:.5rem;margin-bottom:.5rem}
  .msg .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;flex:0 0 36px}
  .msg .bubble{max-width:78%;padding:.5rem .65rem;border-radius:.75rem;background:#f4f6f8}
  .msg .meta{font-size:.75rem;color:#6c757d;margin-top:.125rem}
  .msg.mine{flex-direction:row-reverse}
  .msg.mine .bubble{background:#e7f1ff}
  .msg.mine .meta{text-align:right}

  /* Fullscreen viewer */
  #viewer.d-none{display:none}
  #viewer{position:fixed;inset:0;z-index:1060;display:flex;align-items:center;justify-content:center}
  #viewerBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.85)}
  #viewerToolbar{position:absolute;top:16px;right:16px;display:flex;gap:8px;border-radius:10px;background:#fff;padding:8px 10px;z-index:1062;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  #viewerImg{
    position:relative;z-index:1061;
    max-width:calc(100vw - 64px);
    max-height:calc(100vh - 112px);
    width:auto;height:auto;object-fit:contain;
    transform:translate(var(--tx,0px),var(--ty,0px)) scale(var(--s,1));
    cursor:grab;user-select:none;will-change:transform;
  }
  #viewer.grabbing #viewerImg{cursor:grabbing}

  /* TUI in a fullscreen modal; hide default "Load" button" */
  .modal-fullscreen .modal-body{padding:0}
  #tui-editor-wrap{height:calc(100vh - 120px)}
  .tui-image-editor-header-buttons .tui-image-editor-load-btn{display:none!important}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="h4 mb-0">{{ patient.ptnName }} {{ patient.ptnLastname }}</h2>
      <div class="text-muted small">Geburtsdatum: {{ patient.ptnDOB }}</div>
      {% if patient.group %}
      <div class="text-muted small">Gruppe: <a href="{% url 'group_detail' patient.group.id %}">{{ patient.group.name }}</a></div>
      {% endif %}
    </div>
    <button id="btnComments" class="btn btn-outline-primary btn-sm" title="Fallbezogene Kommentare und Verlauf">
      <i class="far fa-comments"></i> Kommentare
      {% if comments %}<span id="commentsCount" class="badge bg-primary text-white">{{ comments|length }}</span>{% else %}<span id="commentsCount" class="badge bg-primary text-white d-none">0</span>{% endif %}
    </button>
  </div>

  <!-- Uploader -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
      <strong>Dateien hochladen</strong>
      <span class="text-muted small ms-2">Bilder, Videos &amp; STL • Drag &amp; Drop oder Klick</span>
    </div>
    <div class="card-body">
      <div id="dropzone" class="border border-2 border-dashed rounded-3 p-4 text-center" style="border-style:dashed;cursor:pointer;">
        <div class="mb-2"><i class="fas fa-cloud-upload-alt fa-2x text-primary"></i></div>
        <div class="fw-semibold">Dateien hierher ziehen</div>
        <div class="text-muted small">oder klicken, um auszuwählen</div>
        <input id="filePicker" type="file" accept="image/*,video/*,.stl,model/stl,application/sla" multiple hidden>
      </div>
      <div id="uploadProgress" class="progress mt-3 d-none" aria-hidden="true">
        <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
      </div>
      <div id="uploadStatus" class="small text-muted mt-1 d-none"></div>
      <div class="form-text mt-2">Unterstützt: JPG, PNG, WEBP, GIF, HEIC/HEIF*, MP4, MOV, WEBM, STL.</div>
    </div>
  </div>

  <!-- Images -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white"><strong>Bilder</strong></div>
    <div class="card-body">
      <form method="POST" action="{% url 'delete_images' patient.id %}">
        {% csrf_token %}
        <div class="row g-3">
          {% if images %}
            {% for image in images %}
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
              <div class="card h-100 border-0 shadow-sm">
                <div class="position-relative">
                  <img
                    src="{{ image.image.url }}"
                    class="w-100 img-thumb"
                    style="height:140px;object-fit:cover;border-top-left-radius:.25rem;border-top-right-radius:.25rem;"
                    data-id="{{ image.id }}"
                    alt="Bild"
                    onclick="openViewerIndex({{ forloop.counter0 }})">
                  <div class="position-absolute top-0 start-0 p-1">
                    <input class="form-check-input" type="checkbox" name="selected_images" value="{{ image.id }}">
                  </div>
                </div>
                <div class="card-body p-2 d-flex justify-content-between">
                  <a class="btn btn-sm btn-outline-primary" href="{{ image.image.url }}" download title="Herunterladen"><i class="fas fa-download"></i></a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'delete_single_image' image.id %}" title="Löschen"><i class="fas fa-trash-alt"></i></a>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="col-12 text-muted">Keine Bilder vorhanden.</div>
          {% endif %}
        </div>
        <div class="text-end mt-3">
          <button type="submit" class="btn btn-sm btn-outline-danger">Ausgewählte löschen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Videos -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white"><strong>Videos</strong></div>
    <div class="card-body">
      <form method="POST" action="{% url 'delete_videos' patient.id %}">
        {% csrf_token %}
        <div class="row g-3">
          {% if videos %}
            {% for v in videos %}
            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="position-relative">
                  <video src="{{ v.file.url }}" controls style="width:100%;height:180px;object-fit:cover;border-top-left-radius:.25rem;border-top-right-radius:.25rem;"></video>
                  <div class="position-absolute top-0 start-0 p-1">
                    <input class="form-check-input" type="checkbox" name="selected_videos" value="{{ v.id }}">
                  </div>
                </div>
                <div class="card-body p-2 d-flex justify-content-between">
                  <a class="btn btn-sm btn-outline-primary" href="{{ v.file.url }}" download title="Herunterladen"><i class="fas fa-download"></i></a>
                  <a class="btn btn-sm btn-outline-danger" href="{% url 'delete_single_video' v.id %}" title="Löschen"><i class="fas fa-trash-alt"></i></a>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="col-12 text-muted">Keine Videos vorhanden.</div>
          {% endif %}
        </div>
        <div class="text-end mt-3">
          <button type="submit" class="btn btn-sm btn-outline-danger">Ausgewählte löschen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 3D models -->
  <div class="card shadow-sm mb-4" id="models3d">
    <div class="card-header bg-white d-flex align-items-center justify-content-between">
      <strong>3D-Modelle (.stl)</strong>
      <a class="btn btn-outline-secondary btn-sm" href="#dropzone">Neu hochladen</a>
    </div>
    <div class="card-body">
      <form method="POST" action="/patient/{{ patient.id }}/delete_models/">
        {% csrf_token %}
        <div class="row g-3">
          {% if models3d %}
            {% for m in models3d %}
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
              <div class="card h-100 border-0 shadow-sm">
                <div class="position-relative">
                  {% if m.thumbnail %}
                    <img src="{{ m.thumbnail.url }}" class="w-100" style="height:140px;object-fit:cover;border-top-left-radius:.25rem;border-top-right-radius:.25rem;" alt="3D Thumbnail">
                  {% else %}
                    <div class="d-flex align-items-center justify-content-center" style="height:140px;background:#eef5ff;border:1px dashed #cfe2ff;border-top-left-radius:.25rem;border-top-right-radius:.25rem;">
                      <span class="fw-semibold text-primary"><i class="fas fa-cube me-2"></i>3D</span>
                    </div>
                  {% endif %}
                  <div class="position-absolute top-0 start-0 p-1">
                    <input class="form-check-input" type="checkbox" name="selected_models" value="{{ m.id }}">
                  </div>
                </div>
                <div class="card-body p-2 d-flex justify-content-between">
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="openStlViewer('{{ m.file.url|escapejs }}')" title="Vorschau"><i class="fas fa-vr-cardboard"></i></button>
                  <div class="d-flex gap-1">
                    <a class="btn btn-sm btn-outline-primary" href="{{ m.file.url }}" download title="Herunterladen"><i class="fas fa-download"></i></a>
                    <a class="btn btn-sm btn-outline-danger" href="/model/{{ m.id }}/delete/" title="Löschen"><i class="fas fa-trash-alt"></i></a>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="col-12 text-muted">Keine 3D-Modelle vorhanden.</div>
          {% endif %}
        </div>
        <div class="text-end mt-3">
          <button type="submit" class="btn btn-sm btn-outline-danger">Ausgewählte löschen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Comments Drawer -->
<div id="commentsBackdrop" class="comments-backdrop"></div>
<aside id="commentsDrawer" class="comments-drawer" aria-hidden="true">
  <div class="drawer-header">
    <div class="d-flex align-items-center gap-2">
      <i class="far fa-comments"></i>&nbsp;&nbsp;<strong>Kommentare</strong>&nbsp;&nbsp;
      <span class="badge bg-secondary text-white" id="drawerCount">{{ comments|length }}</span>
    </div>
    <button id="closeComments" class="btn btn-sm btn-outline-secondary"><i class="fas fa-times"></i></button>
  </div>
  <div class="px-3 pb-1 text-muted small">Fallbezogene Kommentare für Verlauf, Rückfragen und Teamabstimmung.</div>
  <div id="commentsList" class="drawer-body" data-last-id="{% if comments %}{{ comments.last.id }}{% else %}0{% endif %}">
    {% for c in comments %}
      <div class="msg {% if c.author_id == request.user.id %}mine{% endif %}">
        <img class="avatar" src="{{ c.author.profile.avatar_url|default:'https://i.pravatar.cc/100?img=1' }}" alt="avatar">
        <div>
          <div class="bubble">{{ c.content|linebreaksbr }}</div>
          <div class="meta">{{ c.author.get_full_name|default:c.author.username }} · <span title="{{ c.created_at|date:'Y-m-d H:i' }}">{{ c.created_at|timesince }} ago</span></div>
        </div>
      </div>
    {% empty %}
      <div class="text-muted">Noch keine Kommentare.</div>
    {% endfor %}
  </div>
  <div class="drawer-footer">
    {% if can_comment %}
    <form id="commentForm">{% csrf_token %}
      <textarea id="commentText" class="form-control mb-2" rows="1" maxlength="2000" placeholder="Kommentar schreiben… (Enter=senden, Shift+Enter=Zeilenumbruch)"></textarea>
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">Nur Besitzer &amp; Freigegebene können kommentieren.</small>
        <button class="btn btn-primary btn-sm" type="submit">Senden</button>
      </div>
    </form>
    {% else %}
      <div class="alert alert-warning mb-0">Kein Kommentarzugriff für diesen Patienten.</div>
    {% endif %}
  </div>
</aside>

<!-- Fullscreen Viewer -->
<div id="viewer" class="d-none">
  <div id="viewerBackdrop"></div>
  <div id="viewerToolbar" class="shadow">
    <button class="btn btn-light btn-sm" onclick="zoomBy(1.2)" title="Vergrößern"><i class="fas fa-search-plus"></i></button>
    <button class="btn btn-light btn-sm" onclick="zoomBy(1/1.2)" title="Verkleinern"><i class="fas fa-search-minus"></i></button>
    <a id="viewerDownload" class="btn btn-light btn-sm" href="#" download title="Herunterladen"><i class="fas fa-download"></i></a>
    <button id="viewerEdit" class="btn btn-primary btn-sm" title="Bearbeiten"><i class="fas fa-pen"></i> Bearbeiten</button>
    <button class="btn btn-light btn-sm" onclick="closeViewer()" title="Schließen"><i class="fas fa-times"></i></button>
  </div>
  <img id="viewerImg" src="" alt="Vorschau">
</div>

<!-- TUI Editor Modal (kept fullscreen) -->
<div class="modal fade modal-fullscreen" id="imageEditorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex align-items-center gap-2">
          <h5 class="modal-title me-2">Bild bearbeiten</h5>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btnReset">Zurücksetzen</button>
          <button type="button" class="btn btn-primary btn-sm" id="btnSave">Speichern</button>
          <button type="button" class="btn btn-success btn-sm" id="btnSaveCopy">Als Kopie speichern</button>
          <button type="button" class="btn btn-outline-info btn-sm" id="btnDownload">Download</button>
        </div>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>
      <div class="modal-body">
        <div id="tui-editor-wrap"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- TUI deps (order matters) -->
<script src="https://uicdn.toast.com/tui-code-snippet/latest/tui-code-snippet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.6.0/fabric.min.js"></script>
<script src="https://uicdn.toast.com/tui-color-picker/latest/tui-color-picker.js"></script>
<script src="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.min.js"></script>

<script>
/* ---------- Helpers ---------- */
function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m? m.pop():''; }
const CSRF_TOKEN=getCookie('csrftoken');
const CURRENT_USER_ID={{ request.user.id }};
function escapeHtml(str){
  const map={"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
  return (str||'').replace(/[&<>"']/g, ch => map[ch]);
}

/* ---------- Comments drawer ---------- */
const btnComments=document.getElementById('btnComments');
const drawer=document.getElementById('commentsDrawer');
const backdrop=document.getElementById('commentsBackdrop');
document.getElementById('closeComments').addEventListener('click',()=>{drawer.classList.remove('open');backdrop.classList.remove('show')});
btnComments.addEventListener('click',()=>{drawer.classList.add('open');backdrop.classList.add('show')});
backdrop.addEventListener('click',()=>{drawer.classList.remove('open');backdrop.classList.remove('show')});

// Comment submit + live append
const commentsList=document.getElementById('commentsList');
const drawerCount=document.getElementById('drawerCount');
const commentsCount=document.getElementById('commentsCount');
const COMMENT_URL="{% url 'add_comment' patient.id %}";
const FEED_URL="{% url 'comments_feed' patient.id %}";
const MY_AVATAR="{{ request.user.profile.avatar_url|default:'https://i.pravatar.cc/100?img=1'|escapejs }}";
const MY_NAME="{{ request.user.get_full_name|default:request.user.username|escapejs }}";
let lastCommentId=Number(commentsList?.dataset.lastId||0);

const appendComment = (c, mine=false) => {
  if(!commentsList) return;
  const empty = commentsList.querySelector('.text-muted');
  if(empty) empty.remove();
  const node=document.createElement('div');
  const isMine = mine || c.author_id===CURRENT_USER_ID;
  node.className='msg'+(isMine?' mine':'');
  node.innerHTML=`
    <img class="avatar" src="${(c.avatar_url||MY_AVATAR||'https://i.pravatar.cc/100?img=1')}" alt="avatar">
    <div>
      <div class="bubble">${escapeHtml(c.content||'').replace(/\n/g,'<br>')}</div>
      <div class="meta">${escapeHtml(c.author||MY_NAME||'')} · ${c.created_human||'gerade eben'}</div>
    </div>`;
  commentsList.appendChild(node);
  lastCommentId = Math.max(lastCommentId, Number(c.id||0));
  commentsList.dataset.lastId = String(lastCommentId);
  const currentCount = Number(drawerCount?.textContent||0)+1;
  if(drawerCount) drawerCount.textContent=currentCount;
  if(commentsCount){commentsCount.textContent=currentCount;commentsCount.classList.remove('d-none');}
};

const commentForm=document.getElementById('commentForm');
if(commentForm){
  const commentText=document.getElementById('commentText');
  const submitBtn=commentForm.querySelector('button[type="submit"]');

  commentForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text=(commentText.value||'').trim();
    if(!text) return;
    submitBtn.disabled=true;
    try{
      const fd=new FormData();
      fd.append('csrfmiddlewaretoken', CSRF_TOKEN);
      fd.append('content', text);
      const res=await fetch(COMMENT_URL,{method:'POST',headers:{'X-CSRFToken':CSRF_TOKEN},body:fd});
      const data=await res.json().catch(()=>({ok:false,error:'Serverfehler'}));
      if(!res.ok || !data.ok){ alert(data.error||'Kommentar konnte nicht gespeichert werden.'); return; }
      appendComment(data, true);
      commentText.value='';
      commentText.focus();
    }catch(_){
      alert('Netzwerkfehler beim Senden.');
    }finally{
      submitBtn.disabled=false;
    }
  });

  commentText.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); commentForm.requestSubmit(); }
  });
}

const fetchNewComments = async () => {
  if(!commentsList) return;
  try{
    const res = await fetch(`${FEED_URL}?after_id=${lastCommentId}`);
    const data = await res.json().catch(()=>({ok:false}));
    if(!res.ok || !data.ok) return;
    if(Array.isArray(data.comments)){
      data.comments.forEach(c => appendComment(c, c.author_id===CURRENT_USER_ID));
    }
  }catch(_){ /* ignore network hiccups */ }
};

setInterval(fetchNewComments, 8000);

/* ---------- Upload (minimal) ---------- */
const dropzone=document.getElementById('dropzone'), picker=document.getElementById('filePicker');
dropzone.addEventListener('click',()=>picker.click());
dropzone.addEventListener('dragover',e=>{e.preventDefault();dropzone.classList.add('dragover')});
dropzone.addEventListener('dragleave',()=>dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop',e=>{e.preventDefault();dropzone.classList.remove('dragover');handleFiles(e.dataTransfer.files)});
picker.addEventListener('change',e=>handleFiles(e.target.files));
function handleFiles(list){
  const files=[...list]; if(!files.length) return;
  const U_IMG="{% url 'upload_images' patient.id %}", U_VID="{% url 'upload_videos' patient.id %}", U_STL="{% url 'upload_models' patient.id %}";
  const bar=document.getElementById('uploadProgressBar');
  const wrap=document.getElementById('uploadProgress');
  const status=document.getElementById('uploadStatus');
  const totalBytes = Math.max(1, files.reduce((s,f)=>s+(f.size||0),0));
  let sentBytes = 0;

  const showProgress = (pct, txt) => {
    if(!bar||!wrap||!status) return;
    wrap.classList.remove('d-none'); wrap.setAttribute('aria-hidden','false');
    status.classList.remove('d-none');
    const clamped=Math.min(100,Math.max(0,Math.round(pct)));
    bar.style.width=clamped+'%';
    bar.textContent=clamped+'%';
    status.textContent=txt;
  };

  const uploadFile = (file, url, field) => new Promise((resolve,reject)=>{
    const fd=new FormData(); fd.append('csrfmiddlewaretoken',CSRF_TOKEN); fd.append(field,file);
    const xhr=new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.setRequestHeader('X-CSRFToken', CSRF_TOKEN);
    xhr.upload.onprogress = (e)=>{
      if(e.lengthComputable){
        const pct = (sentBytes + e.loaded) / totalBytes * 100;
        showProgress(pct, `Lade hoch: ${file.name}`);
      }
    };
    xhr.onload = () => {
      if(xhr.status>=200 && xhr.status<300){
        sentBytes += file.size||0;
        const pct = sentBytes / totalBytes * 100;
        showProgress(pct, `Fertig: ${file.name}`);
        resolve();
      } else {
        showProgress(0, `Fehler bei ${file.name}`);
        reject(new Error('upload failed'));
      }
    };
    xhr.onerror = () => { showProgress(0, `Fehler bei ${file.name}`); reject(new Error('upload error')); };
    xhr.send(fd);
  });

  (async()=>{
    showProgress(0,'Starte Upload...');
    for(const f of files){
      const n=(f.name||'').toLowerCase();
      const isImg=f.type.startsWith('image/'); const isVid=f.type.startsWith('video/'); const isStl=n.endsWith('.stl')||f.type==='model/stl'||f.type==='application/sla';
      let url=null, field=null;
      if(isImg){url=U_IMG; field='images'} else if(isVid){url=U_VID; field='videos'} else if(isStl){url=U_STL; field='models'} else {continue;}
      try{ await uploadFile(f, url, field); }catch(_){ /* keep going to next file */ }
    }
    showProgress(100,'Abgeschlossen, aktualisiere...');
    setTimeout(()=>location.reload(), 400);
  })();
}

/* ---------- Fullscreen image viewer ---------- */
let s=1,tx=0,ty=0, IMAGES=[], CURRENT_INDEX=0;
const viewer=document.getElementById('viewer');
const viewerImg=document.getElementById('viewerImg');
const viewerDownload=document.getElementById('viewerDownload');
const viewerEdit=document.getElementById('viewerEdit');
const viewerBackdrop=document.getElementById('viewerBackdrop');

function collectImages(){
  IMAGES = Array.from(document.querySelectorAll('.img-thumb')).map(el => ({
    src: el.getAttribute('src'),
    id:  el.dataset.id
  }));
}
collectImages();

function openViewerIndex(i){
  if(!IMAGES.length) collectImages();
  CURRENT_INDEX = Math.max(0, Math.min(i, IMAGES.length-1));
  openViewer(IMAGES[CURRENT_INDEX]);
}
window.openViewerIndex = openViewerIndex;

function openViewer(obj){
  s=1; tx=0; ty=0;
  viewerImg.style.setProperty('--s',1); viewerImg.style.setProperty('--tx','0px'); viewerImg.style.setProperty('--ty','0px');
  viewerImg.src = obj.src; viewerDownload.href = obj.src;
  viewer.classList.remove('d-none');
}
function closeViewer(){ viewer.classList.add('d-none'); viewerImg.src=''; }
function zoomBy(f){ s=Math.max(1,Math.min(8,s*f)); if(s===1){tx=0;ty=0} viewerImg.style.setProperty('--s',s); viewerImg.style.setProperty('--tx',tx+'px'); viewerImg.style.setProperty('--ty',ty+'px'); }

viewer.addEventListener('wheel',e=>{ e.preventDefault(); const d=e.deltaY||e.wheelDelta; zoomBy(d>0?1/1.15:1.15) }, {passive:false});
let dragging=false,sx=0,sy=0;
viewerImg.addEventListener('mousedown',e=>{ if(s===1) return; dragging=true; sx=e.clientX; sy=e.clientY; viewer.classList.add('grabbing'); });
window.addEventListener('mousemove',e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; sx=e.clientX; sy=e.clientY; tx+=dx; ty+=dy; viewerImg.style.setProperty('--tx',tx+'px'); viewerImg.style.setProperty('--ty',ty+'px'); });
window.addEventListener('mouseup',()=>{ dragging=false; viewer.classList.remove('grabbing'); });
viewerBackdrop.addEventListener('click', closeViewer);

window.addEventListener('keydown',e=>{
  if(viewer.classList.contains('d-none')) return;
  if(e.key==='Escape'){ e.preventDefault(); closeViewer(); }
  else if(e.key==='ArrowRight'){ e.preventDefault(); CURRENT_INDEX=(CURRENT_INDEX+1)%IMAGES.length; openViewer(IMAGES[CURRENT_INDEX]); }
  else if(e.key==='ArrowLeft'){ e.preventDefault(); CURRENT_INDEX=(CURRENT_INDEX-1+IMAGES.length)%IMAGES.length; openViewer(IMAGES[CURRENT_INDEX]); }
  else if(e.key==='d' || e.key==='D'){ e.preventDefault(); viewerDownload.click(); }
});

/* ---------- TUI editor (init on modal shown) ---------- */
let tuiEditor=null, currentEditUrl=null, currentEditId=null;
const modalEl=document.getElementById('imageEditorModal');

function openTUIEditor(url, id){
  currentEditUrl=url; currentEditId=id;

  // Close viewer first
  closeViewer();

  // Build editor AFTER modal is visible
  const onShown = () => {
    try { tuiEditor?.destroy(); } catch(_) {}
    tuiEditor = new tui.ImageEditor('#tui-editor-wrap', {
      includeUI: {
        loadImage: { path: currentEditUrl, name: 'image' },
        menu: ['crop','draw','shape','text','filter','rotate','flip'],
        initMenu: 'crop',
        menuBarPosition: 'bottom'
      },
      cssMaxWidth: 1600,
      cssMaxHeight: 1000,
      selectionStyle: { cornerSize: 16, rotatingPointOffset: 40 }
    });
    setTimeout(()=>{ try{ tuiEditor.ui.resizeEditor(); }catch(_){ } }, 50);

    document.getElementById('btnReset').onclick = async () => {
      try {
        await tuiEditor.loadImageFromURL(currentEditUrl, 'image');
        tuiEditor.clearUndoStack();
        setTimeout(()=>{ try{ tuiEditor.ui.resizeEditor(); }catch(_){ } }, 30);
      } catch(e){ alert('Zurücksetzen fehlgeschlagen.'); }
    };
    document.getElementById('btnSave').onclick = async () => {
      try{
        const dataURL=tuiEditor.toDataURL(); const blob=await (await fetch(dataURL)).blob();
        const fd=new FormData(); fd.append('image', new File([blob],'edited.png',{type:'image/png'}));
        const res=await fetch(`/image/${currentEditId}/edit/`, {method:'POST', headers:{'X-CSRFToken':CSRF_TOKEN}, body:fd});
        if(!res.ok) throw new Error();
        location.reload();
      }catch(_){ alert('Speichern fehlgeschlagen.'); }
    };
    document.getElementById('btnSaveCopy').onclick = async () => {
      try{
        const dataURL=tuiEditor.toDataURL(); const blob=await (await fetch(dataURL)).blob();
        const fd=new FormData(); fd.append('image', new File([blob],'edited.png',{type:'image/png'})); fd.append('as_new','1');
        const res=await fetch(`/image/${currentEditId}/edit/`, {method:'POST', headers:{'X-CSRFToken':CSRF_TOKEN}, body:fd});
        if(!res.ok) throw new Error();
        location.reload();
      }catch(_){ alert('Speichern fehlgeschlagen.'); }
    };
    document.getElementById('btnDownload').onclick = () => {
      const a=document.createElement('a'); a.href=tuiEditor.toDataURL(); a.download=`image-${currentEditId||'edited'}.png`; document.body.appendChild(a); a.click(); a.remove();
    };
  };

  modalEl.addEventListener('shown.bs.modal', onShown, {once:true});
  bootstrap.Modal.getOrCreateInstance(modalEl).show();

  modalEl.addEventListener('hidden.bs.modal', () => {
    try { tuiEditor?.destroy(); } catch(_) {}
    tuiEditor=null;
  }, {once:true});
}

viewerEdit.addEventListener('click', () => {
  const item = IMAGES[CURRENT_INDEX];
  if(!item) return;
  openTUIEditor(item.src, item.id);
});

/* ---------- Three.js STL viewer (FULLSCREEN) with color controls ---------- */
window.openStlViewer = async (url) => {
  const THREE = await import('three'); // resolved by import map in <head>
  const { OrbitControls } = await import('https://unpkg.com/three@0.158.0/examples/jsm/controls/OrbitControls.js');
  const { STLLoader } = await import('https://unpkg.com/three@0.158.0/examples/jsm/loaders/STLLoader.js');

  // Modal skeleton: fullscreen
  const md=document.createElement('div');
  md.className='modal fade modal-fullscreen';
  md.innerHTML=`
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">3D Vorschau (.stl)</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>
        <div class="modal-body p-0 position-relative">
          <div id="stlWrap" class="position-relative" style="height:calc(100vh - 80px);background:#111"></div>
          <div class="stl-controls">
            <label>Objekt</label>
            <input type="color" id="colModel" class="color" value="#29a3ff" title="Modellfarbe">
            <label>Hintergrund</label>
            <input type="color" id="colBg" class="color" value="#111111" title="Hintergrundfarbe">
            <label>Glanz</label>
            <input type="range" id="shininess" min="0" max="120" value="40" title="Shininess">
            <label class="check"><input type="checkbox" id="wire"> Wireframe</label>
            <label class="check"><input type="checkbox" id="autorotate"> Auto-Rotate</label>
          </div>
        </div>
      </div>
    </div>`;
  document.body.appendChild(md);
  const modal = new bootstrap.Modal(md);
  const wrap = md.querySelector('#stlWrap');

  // Three.js setup
  const scene = new THREE.Scene(); scene.background = new THREE.Color(0x111111);
  const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 5000);
  const renderer = new THREE.WebGLRenderer({ antialias:true });
  wrap.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0xffffff, 0.9));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(1,1,1); scene.add(dir);

  // UI refs
  const colModel = md.querySelector('#colModel');
  const colBg = md.querySelector('#colBg');
  const shininess = md.querySelector('#shininess');
  const wire = md.querySelector('#wire');
  const autorotate = md.querySelector('#autorotate');

  let mesh = null;
  const material = new THREE.MeshPhongMaterial({ color: 0x29a3ff, shininess: 40 });

  // Load STL
  const loader = new STLLoader();
  loader.load(url, (geom) => {
    if (geom.computeVertexNormals) geom.computeVertexNormals();
    mesh = new THREE.Mesh(geom, material);
    scene.add(mesh);

    // Fit
    const box=new THREE.Box3().setFromObject(mesh);
    const size=box.getSize(new THREE.Vector3());
    const center=box.getCenter(new THREE.Vector3());
    mesh.position.sub(center);

    const maxDim = Math.max(size.x,size.y,size.z) || 100;
    const dist = maxDim * 1.6;
    camera.position.set(dist, dist*0.8, dist);
    camera.lookAt(0,0,0);
    controls.update();
    render();
  }, undefined, () => {
    wrap.innerHTML='<div class="p-3 text-danger">STL konnte nicht geladen werden.</div>';
  });

  // Controls behavior
  colModel.addEventListener('input', () => { material.color = new THREE.Color(colModel.value); });
  colBg.addEventListener('input', () => { scene.background = new THREE.Color(colBg.value); });
  shininess.addEventListener('input', () => { material.shininess = Number(shininess.value); });
  wire.addEventListener('change', () => { material.wireframe = wire.checked; });

  // Resize
  const ro=new ResizeObserver(()=> {
    const w=wrap.clientWidth, h=wrap.clientHeight||1;
    renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix();
  });
  ro.observe(wrap);

  // Loop
  let alive = true;
  function render(){ if(!alive) return; requestAnimationFrame(render);
    if (autorotate.checked && mesh) mesh.rotation.y += 0.01;
    controls.update(); renderer.render(scene,camera);
  }

  md.addEventListener('hidden.bs.modal', ()=>{ alive=false; ro.disconnect(); renderer.dispose(); md.remove(); }, {once:true});
  modal.show();
};
</script>
{% endblock %}
