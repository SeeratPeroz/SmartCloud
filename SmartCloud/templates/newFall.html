<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Modal HTML -->
<div class="modal fade" id="newFallModal" tabindex="-1" aria-labelledby="newFallModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="newPatientForm" method="POST" action="{% url 'add_patient' %}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="newFallModalLabel">Neuer Patient</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="SchlieÃŸen"></button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <label for="ptnName" class="form-label">Vorname</label>
            <input type="text" class="form-control" id="ptnName" name="ptnName" required>
          </div>
          <div class="mb-3">
            <label for="ptnLastname" class="form-label">Nachname</label>
            <input type="text" class="form-control" id="ptnLastname" name="ptnLastname" required>
          </div>
          <div class="mb-3">
            <label for="ptnDOB" class="form-label">Geburtsdatum</label>
            <input type="date" class="form-control" id="ptnDOB" name="ptnDOB" required>
          </div>
          <input type="hidden" id="group_id" name="group_id">
          {% if groups %}
          <div class="mb-3" id="groupSelectWrap">
            <label for="groupSelect" class="form-label">Gruppe (optional)</label>
            <select class="form-select" id="groupSelect">
              <option value="">Ohne Gruppe</option>
              {% for g in groups %}
                <option value="{{ g.id }}">{{ g.name }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Faelle in Gruppen sind nur innerhalb der Gruppe sichtbar.</div>
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap JS Bundle - required for modal -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function loadNewFallModal(groupId) {
    const modalEl = document.getElementById('newFallModal');
    const modal = new bootstrap.Modal(modalEl);
    const groupInput = document.getElementById('group_id');
    const groupSelect = document.getElementById('groupSelect');
    const groupWrap = document.getElementById('groupSelectWrap');

    if (groupInput) {
      groupInput.value = groupId || '';
    }

    if (groupSelect) {
      if (groupId) {
        groupSelect.value = groupId;
        groupSelect.disabled = true;
        if (groupWrap) groupWrap.style.display = 'none';
      } else {
        groupSelect.disabled = false;
        if (groupWrap) groupWrap.style.display = '';
        groupInput.value = groupSelect.value || '';
      }

      if (!groupSelect.dataset.bound) {
        groupSelect.addEventListener('change', function () {
          if (groupInput) {
            groupInput.value = groupSelect.value || '';
          }
        });
        groupSelect.dataset.bound = '1';
      }
    }

    modal.show();
  }
</script>
