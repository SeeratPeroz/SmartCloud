{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - SmartCloud{% endblock %}

{% block content %}
<h1 class="h3 mb-4 text-gray-800">Dashboard</h1>

<div class="container py-3">
    <!-- Search bar -->
    <div class="mb-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Search falls by patient name..." onkeyup="filterFalls()">
    </div>

    <div class="row g-3" id="fallsContainer">
        <!-- Add new fall card -->
        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
            <div class="card text-white bg-primary text-center" style="height: 180px; cursor: pointer;" onclick="loadNewFallModal()">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <div class="display-4">+</div>
                    <div>Neuer Fall</div>
                </div>
            </div>
        </div>

        {% for patient in patients %}
            <div class="col-6 col-sm-4 col-md-3 col-lg-2 fall-card" data-patient-name="{{ patient.ptnName }} {{ patient.ptnLastname }}">
                <a href="{% url 'patientImage' patient.id %}" style="text-decoration: none; color: inherit;">
                    <div class="card text-white bg-info text-center position-relative" style="height: 180px; cursor: pointer;">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <img src="https://img.icons8.com/ios-filled/40/ffffff/task.png" class="mb-3" alt="Case Icon">
                            <h6 class="text-white fw-bold">{{ patient.ptnName }} {{ patient.ptnLastname }}</h6>
                        </div>
                        <!-- Delete button -->
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2" 
                                onclick="event.preventDefault(); confirmDelete({{ patient.id }}, this)">
                            &times;
                        </button>
                    </div>
                </a>
            </div>
        {% empty %}
            <p>No patients found.</p>
        {% endfor %}
    </div>

    {% include 'newFall.html' %}
</div>

<p>Welcome to SmartCloud! This is your index page.</p>

<script>
    function loadNewFallModal() {
        const modal = new bootstrap.Modal(document.getElementById('newFallModal'));
        modal.show();
    }

    // Filter falls by patient name dynamically
    function filterFalls() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const falls = document.querySelectorAll('.fall-card');

        falls.forEach(fall => {
            const name = fall.getAttribute('data-patient-name').toLowerCase();
            if (name.includes(input)) {
                fall.style.display = '';
            } else {
                fall.style.display = 'none';
            }
        });
    }

    // Confirm delete action
    function confirmDelete(patientId, btn) {
        if (confirm('Are you sure you want to delete this fall?')) {
            // Option 1: Submit a hidden form (preferred for full page reload)
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `{% url 'delete_patient' 0 %}`.replace('0', patientId);

            // Add CSRF token input
            const csrfToken = '{{ csrf_token }}';
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();

            // Option 2: You can do AJAX here for better UX
        }
    }
</script>

{% endblock %}
