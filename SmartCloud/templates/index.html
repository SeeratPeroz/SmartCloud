{% extends 'base.html' %}
{% load static %}

{% block title %}√úbersicht - CleverCloud{% endblock %}

{% block content %}
<h1 class="h3 mb-4 text-gray-800">√úbersicht</h1>

<style>
/* Chat box base style */
#chat-box {
    position: fixed;
    bottom: -600px;
    right: 30px;
    width: 380px;
    height: 550px;
    border-radius: 12px;
    background: white;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    z-index: 1051;
    display: flex;
    flex-direction: column;
    transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}
#chat-box.open { bottom: 90px; }

#chat-toggle {
    position: fixed;
    bottom: 20px;
    right: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    font-size: 24px;
    cursor: pointer;
    z-index: 1050;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
#chat-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}
#chat-toggle:active {
    transform: scale(0.95);
}

.chat-header {
    padding: 16px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}
.chat-header strong {
    font-size: 16px;
    font-weight: 600;
}
.chat-close-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}
.chat-close-btn:hover {
    background: rgba(255,255,255,0.3);
}

.user-list-header {
    padding: 14px 20px;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
    font-size: 14px;
}

.user-search-container {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
    background: white;
}
.user-search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
}
.user-search-input:focus {
    border-color: #667eea;
}
.user-search-input::placeholder {
    color: #9ca3af;
}

.user-item {
    padding: 14px 20px;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.2s;
}
.user-item:hover {
    background: #f9fafb;
}
.user-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
    flex-shrink: 0;
}
.user-info {
    flex: 1;
    min-width: 0;
}
.user-name {
    font-weight: 600;
    color: #111827;
    font-size: 14px;
    margin-bottom: 2px;
}
.user-username {
    font-size: 12px;
    color: #6b7280;
}

.chat-subheader {
    padding: 12px 20px;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
    display: flex;
    align-items: center;
    gap: 12px;
}
.back-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    color: #6b7280;
    padding: 4px;
    transition: color 0.2s;
}
.back-btn:hover {
    color: #374151;
}

#chat-messages {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    background: #ffffff;
}
#chat-messages::-webkit-scrollbar {
    width: 6px;
}
#chat-messages::-webkit-scrollbar-track {
    background: #f3f4f6;
}
#chat-messages::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
}
.message-item {
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
}
.message-sender {
    font-weight: 600;
    font-size: 13px;
    color: #667eea;
    margin-bottom: 4px;
}
.message-content {
    background: #f3f4f6;
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 14px;
    color: #374151;
    max-width: 85%;
}

.chat-input-container {
    padding: 14px 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 8px;
    background: #ffffff;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
}
#chat-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}
#chat-input:focus {
    border-color: #667eea;
}
.send-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: transform 0.2s, box-shadow 0.2s;
}
.send-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}
.send-btn:active {
    transform: translateY(0);
}

.no-users {
    padding: 40px 20px;
    text-align: center;
    color: #9ca3af;
    font-size: 14px;
}

/* Unread badge */
#unread-count {
    display: none;
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 11px;
    font-weight: 700;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
}

/* Patient card */
.patient-thumb {
    width: 100%;
    height: 105px;
    object-fit: cover;
    border-top-left-radius: .25rem;
    border-top-right-radius: .25rem;
}
.gear-btn { position: absolute; top: .5rem; left: .5rem; z-index: 2; }
/* extra share button (owner only) */
.share-btn { position:absolute; top:.5rem; left:2.9rem; z-index:2; }

/* Visibility badges */
.vis-badge{display:inline-block; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:6px;}
.vis-private{background:#eee; color:#111;}
.vis-shared{background:#fff3cd; color:#7a5200; border:1px solid #ffe69c;}
.vis-public{background:#d1fae5; color:#065f46; border:1px solid #a7f3d0;}

/* Owner/shared chips */
.chip-row{
  display:flex; flex-wrap:wrap; gap:6px; justify-content:center;
  margin-top:6px; padding:0 10px;   /* nudge inside card */
}
.owner-chip{
  width:32px; height:32px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-weight:700; font-size:14px; color:#fff;
  background: linear-gradient(135deg,#2fa6a0,#58d1b9);
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}
.owner-chip.shared{ background: linear-gradient(135deg,#475569,#94a3b8); }
.owner-chip.more{ background:#e2e8f0; color:#0f172a; font-weight:800; }
</style>

<div class="container py-3">

  <!-- Scope filter -->
  <div class="d-flex align-items-center gap-2 mb-3">
    <div class="btn-group" role="group" aria-label="Patient scope">
      <a href="{% url 'index' %}?scope=all"
         class="btn btn-outline-primary {% if scope == 'all' %}active{% endif %}">
        Alle <span class="badge bg-primary ms-1">{{ counts.all }}</span>
      </a>
      <a href="{% url 'index' %}?scope=mine"
         class="btn btn-outline-primary {% if scope == 'mine' %}active{% endif %}">
        Meine <span class="badge bg-primary ms-1">{{ counts.mine }}</span>
      </a>
      <a href="{% url 'index' %}?scope=shared"
         class="btn btn-outline-primary {% if scope == 'shared' %}active{% endif %}">
        Mit mir geteilt <span class="badge bg-primary ms-1">{{ counts.shared }}</span>
      </a>
    </div>
  </div>

  <!-- Owner filter (staff only) -->
  {% if request.user.is_staff %}
  <form method="get" class="mb-3 d-flex align-items-center gap-2">
    <input type="hidden" name="scope" value="{{ scope|default:'all' }}">
    <select name="owner" class="form-select form-select-sm" style="max-width:220px;">
      <option value="">Alle Eigent√ºmer</option>
      {% for u in users %}
        <option value="{{ u.id }}" {% if request.GET.owner == u.id|stringformat:"s" %}selected{% endif %}>
          {{ u.get_full_name|default:u.username }}
        </option>
      {% endfor %}
    </select>
    <button class="btn btn-outline-secondary btn-sm" type="submit">Filtern</button>
  </form>
  {% endif %}

  <!-- Search bar -->
  <div class="mb-4">
    <input type="text" id="searchInput" class="form-control" placeholder="Patienten suchen..." onkeyup="filterPatients()">
  </div>

  <div class="row g-3" id="fallsContainer">
    <!-- Add new fall card -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <div class="card text-white bg-primary text-center" style="height: 180px; cursor: pointer;" onclick="loadNewFallModal()">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <div class="display-4">+</div>
          <div>Neuer Fall</div>
        </div>
      </div>
    </div>

    {% for patient in patients %}
    <div class="col-6 col-sm-4 col-md-3 col-lg-2 fall-card" data-patient-name="{{ patient.ptnName }} {{ patient.ptnLastname }}">
      <div class="card text-center position-relative" style="height: 180px;">
        {% if patient.usrID_id == request.user.id %}
          <a href="{% url 'patient_manage' patient.id %}" class="btn btn-light btn-sm gear-btn" title="Patient verwalten">
            <i class="fas fa-cog"></i>
          </a>
          <!-- Owner-only share shortcut: opens manage page with ?open=share -->

        {% endif %}

        <a href="{% url 'patientImage' patient.id %}" style="text-decoration: none; color: inherit;">
          {% if patient.thumbnail %}
            <img src="{{ patient.thumbnail.url }}" class="patient-thumb" alt="Thumbnail von {{ patient.ptnName }} {{ patient.ptnLastname }}">
          {% else %}    
            <div class="bg-info d-flex align-items-center justify-content-center" style="height:105px; border-top-left-radius:.25rem; border-top-right-radius:.25rem;">
              <img src="https://img.icons8.com/ios-filled/40/ffffff/task.png" alt="Case Icon">
            </div>
          {% endif %}
          <div class="card-body d-flex flex-column justify-content-center align-items-center p-2">
            <h6 class="fw-bold mb-0">
              {{ patient.ptnName }} {{ patient.ptnLastname }}
              {% if patient.visibility == 'PRIVATE' %}
                <span class="vis-badge vis-private" title="Nur Eigent√ºmer und Admins">Privat</span>
              {% elif patient.visibility == 'SHARED' %}
                <span class="vis-badge vis-shared" title="Mit ausgew√§hlten Nutzern geteilt">Geteilt</span>
              {% elif patient.visibility == 'PUBLIC_ORG' %}
                <span class="vis-badge vis-public" title="F√ºr alle angemeldeten Nutzer sichtbar">√ñffentlich</span>
              {% endif %}
            </h6>

            {% if patient.usrID_id == request.user.id %}
              <span class="badge bg-light text-dark mt-1">Eigent√ºmer</span>
            {% elif patient.shared_with.all|length and request.user in patient.shared_with.all %}
              <span class="badge bg-warning text-dark mt-1">Geteilt</span>
            {% else %}
              <span class="badge bg-secondary mt-1">Fremd</span>
            {% endif %}

            <!-- Chips per visibility rules -->
            {% if patient.visibility == 'PRIVATE' %}
              <!-- Only owner emoji -->
              <div class="chip-row">
                {% with owner_name=patient.usrID.get_full_name|default:patient.usrID.username %}
                  <div class="owner-chip" title="Eigent√ºmer: {{ owner_name }}">
                    {{ owner_name|slice:":1"|upper }}
                  </div>
                {% endwith %}
              </div>
            {% elif patient.visibility == 'SHARED' %}
              <!-- Only shared users' emojis -->
              {% with shared_list=patient.shared_with.all %}
                {% if shared_list|length > 0 %}
                <div class="chip-row">
                  {% for u in shared_list|slice:":5" %}
                    {% with un=u.get_full_name|default:u.username %}
                      <div class="owner-chip shared" title="Geteilt mit: {{ un }}">
                        {{ un|slice:":1"|upper }}
                      </div>
                    {% endwith %}
                  {% endfor %}
                  {% if shared_list|length > 5 %}
                    <div class="owner-chip more" title="Weitere geteilt: {{ shared_list|length|add:'-5' }}">‚Ä¶</div>
                  {% endif %}
                </div>
                {% endif %}
              {% endwith %}
            {% else %}
              <!-- PUBLIC_ORG: show no emojis -->
            {% endif %}
          </div>
        </a>

        {% if patient.usrID_id == request.user.id or request.user.is_staff or request.user.is_superuser %}
        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2"
                onclick="event.preventDefault(); confirmDelete({{ patient.id }}, this)">
          &times;
        </button>
        {% endif %}
      </div>
    </div>
    {% empty %}
      <p>Keine Patienten gefunden. Bitte f√ºgen Sie neue Patienten hinzu.</p>
    {% endfor %}
  </div>

  {% include 'newFall.html' %}
</div>

<button id="chat-toggle" title="Chat √∂ffnen">
  üí¨
  <span id="unread-count">0</span>
</button>

<div id="chat-box">
  <!-- Header -->
  <div class="chat-header">
    <strong id="chat-with">Chat ausw√§hlen</strong>
    <button onclick="closeChatBox()" class="chat-close-btn">&times;</button>
  </div>
  
  <!-- User list (shown by default) -->
  <div id="user-list" style="flex:1; overflow-y:auto; display:flex; flex-direction:column;">
    <div class="user-list-header">
      Nachricht senden an:
    </div>
    <div class="user-search-container">
      <input type="text" id="chat-user-search" class="user-search-input" placeholder="Benutzer suchen..." onkeyup="filterChatUsers()">
    </div>
    {% for user in users %}
    <div onclick="startChat({{ user.id }}, '{{ user.get_full_name|default:user.username }}')" class="user-item" data-username="{{ user.username|lower }}" data-fullname="{{ user.get_full_name|default:user.username|lower }}">
      <div class="user-avatar">
        {{ user.get_full_name|default:user.username|slice:":1"|upper }}
      </div>
      <div class="user-info">
        <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
        <div class="user-username">@{{ user.username }}</div>
      </div>
    </div>
    {% empty %}
    <div class="no-users">
      Keine anderen Benutzer verf√ºgbar
    </div>
    {% endfor %}
  </div>
  
  <!-- Chat area (hidden until user selected) -->
  <div id="chat-area" style="display:none; flex:1; display:flex; flex-direction:column;">
    <div class="chat-subheader">
      <button onclick="backToUserList()" class="back-btn">‚Üê</button>
      <strong id="chat-username" style="color:#374151; font-size:14px;">Chat</strong>
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input-container">
      <input id="chat-input" type="text" placeholder="Nachricht eingeben..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" class="send-btn">Senden</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Chat toggle button
  const chatToggle = document.getElementById("chat-toggle");
  const chatBox = document.getElementById("chat-box");
  
  if (chatToggle && chatBox) {
    chatToggle.addEventListener("click", function() {
      chatBox.classList.toggle("open");
    });
  }

  let chatSocket = null, isSocketOpen = false, receiverId = null, unreadCount = 0;
  
  window.startChat = function(id, username) {
    if (receiverId === id) return;
    receiverId = id;
    
    // Update UI
    document.getElementById('chat-with').textContent = 'Chat mit ' + username;
    document.getElementById('chat-username').textContent = username;
    document.getElementById('chat-messages').innerHTML = '';
    
    // Show chat area, hide user list
    document.getElementById('user-list').style.display = 'none';
    document.getElementById('chat-area').style.display = 'flex';
    
    connectWebSocket();
    resetUnreadCount();
  };
  
  window.backToUserList = function() {
    // Close WebSocket
    if (chatSocket) {
      chatSocket.close();
      chatSocket = null;
    }
    receiverId = null;
    
    // Show user list, hide chat area
    document.getElementById('user-list').style.display = 'block';
    document.getElementById('chat-area').style.display = 'none';
    document.getElementById('chat-with').textContent = 'Chat ausw√§hlen';
  };
  
  function openChatBox() {
    const chatBox = document.getElementById('chat-box');
    if (chatBox) chatBox.classList.add('open');
  }
  
  function closeChatBox() {
    const chatBox = document.getElementById('chat-box');
    if (chatBox) chatBox.classList.remove('open');
  }
  
  function connectWebSocket() {
    if (chatSocket) chatSocket.close();
    if (!receiverId) return;
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${protocol}://${window.location.host}/ws/chat/${receiverId}/`;
    chatSocket = new WebSocket(wsUrl);
    isSocketOpen = false;
    chatSocket.onopen = function(){ isSocketOpen = true; };
    chatSocket.onmessage = function(e){
      const data = JSON.parse(e.data);
      const message = data.message;
      const senderUsername = data.sender_username || 'Unknown';
      const senderIdMsg = data.sender_id;
      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML += `
        <div class="message-item">
          <div class="message-sender">${senderUsername}</div>
          <div class="message-content">${message}</div>
        </div>
      `;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      const chatBox = document.getElementById('chat-box');
      if (senderIdMsg !== receiverId && chatBox && !chatBox.classList.contains('open')) {
        incrementUnreadCount();
      }
    };
    chatSocket.onclose = function(){ isSocketOpen = false; };
    chatSocket.onerror = function(){ isSocketOpen = false; };
  }
  window.sendMessage = function(){
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message || !chatSocket) return;
    if (isSocketOpen) {
      chatSocket.send(JSON.stringify({ 'message': message, 'receiver_id': receiverId }));
      input.value = '';
    }
  };
  function updateUnreadCount(count){
    unreadCount = count;
    const badge = document.getElementById('unread-count');
    if (!badge) return;
    if (unreadCount > 0){ badge.textContent = unreadCount; badge.style.display = 'flex'; }
    else { badge.style.display = 'none'; }
  }
  function incrementUnreadCount(){ unreadCount++; updateUnreadCount(unreadCount); }
  function resetUnreadCount(){ unreadCount = 0; updateUnreadCount(unreadCount); }
  
  // Make functions globally available
  window.openChatBox = openChatBox;
  window.closeChatBox = closeChatBox;
});

function confirmDelete(patientId, buttonElement) {
  if (confirm("Sind Sie sicher, dass Sie diesen Patienten l√∂schen m√∂chten?")) {
    window.location.href = `/delete_patient/${patientId}/`;
  }
}

function filterPatients() {
  let input = document.getElementById("searchInput").value.toLowerCase();
  let cards = document.querySelectorAll("#fallsContainer .fall-card");
  cards.forEach(card => {
    let name = card.getAttribute("data-patient-name").toLowerCase();
    card.style.display = name.includes(input) ? "" : "none";
  });
}

function filterChatUsers() {
  const input = document.getElementById("chat-user-search").value.toLowerCase();
  const userItems = document.querySelectorAll(".user-item");
  
  userItems.forEach(item => {
    const username = item.getAttribute("data-username");
    const fullname = item.getAttribute("data-fullname");
    const matches = username.includes(input) || fullname.includes(input);
    item.style.display = matches ? "flex" : "none";
  });
}
</script>
{% endblock %}