{% extends 'base.html' %}
{% load static %}

{% block title %}√úbersicht - CleverCloud{% endblock %}

{% block content %}
<h1 class="h3 mb-4 text-gray-800">√úbersicht</h1>

<style>
/* Chat box base style */
#chat-box {
    position: fixed;
    bottom: -500px;
    right: 20px;
    width: 400px;
    height: 450px;
    border: 1px solid #ddd;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 1051;
    display: flex;
    flex-direction: column;
    transition: bottom 0.3s ease-in-out;
}
#chat-box.open { bottom: 70px; }
#chat-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 24px;
    cursor: pointer;
    z-index: 1050;
}
/* Patient card */
.patient-thumb {
    width: 100%;
    height: 105px;
    object-fit: cover;
    border-top-left-radius: .25rem;
    border-top-right-radius: .25rem;
}
.gear-btn { position: absolute; top: .5rem; left: .5rem; z-index: 2; }
/* extra share button (owner only) */
.share-btn { position:absolute; top:.5rem; left:2.9rem; z-index:2; }

/* Visibility badges */
.vis-badge{display:inline-block; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:6px;}
.vis-private{background:#eee; color:#111;}
.vis-shared{background:#fff3cd; color:#7a5200; border:1px solid #ffe69c;}
.vis-public{background:#d1fae5; color:#065f46; border:1px solid #a7f3d0;}

/* Owner/shared chips */
.chip-row{
  display:flex; flex-wrap:wrap; gap:6px; justify-content:center;
  margin-top:6px; padding:0 10px;   /* nudge inside card */
}
.owner-chip{
  width:32px; height:32px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-weight:700; font-size:14px; color:#fff;
  background: linear-gradient(135deg,#2fa6a0,#58d1b9);
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}
.owner-chip.shared{ background: linear-gradient(135deg,#475569,#94a3b8); }
.owner-chip.more{ background:#e2e8f0; color:#0f172a; font-weight:800; }
</style>

<div class="container py-3">

  <!-- Scope filter -->
  <div class="d-flex align-items-center gap-2 mb-3">
    <div class="btn-group" role="group" aria-label="Patient scope">
      <a href="{% url 'index' %}?scope=all"
         class="btn btn-outline-primary {% if scope == 'all' %}active{% endif %}">
        Alle <span class="badge bg-primary ms-1">{{ counts.all }}</span>
      </a>
      <a href="{% url 'index' %}?scope=mine"
         class="btn btn-outline-primary {% if scope == 'mine' %}active{% endif %}">
        Meine <span class="badge bg-primary ms-1">{{ counts.mine }}</span>
      </a>
      <a href="{% url 'index' %}?scope=shared"
         class="btn btn-outline-primary {% if scope == 'shared' %}active{% endif %}">
        Mit mir geteilt <span class="badge bg-primary ms-1">{{ counts.shared }}</span>
      </a>
    </div>
  </div>

  <!-- Owner filter (staff only) -->
  {% if request.user.is_staff %}
  <form method="get" class="mb-3 d-flex align-items-center gap-2">
    <input type="hidden" name="scope" value="{{ scope|default:'all' }}">
    <select name="owner" class="form-select form-select-sm" style="max-width:220px;">
      <option value="">Alle Eigent√ºmer</option>
      {% for u in users %}
        <option value="{{ u.id }}" {% if request.GET.owner == u.id|stringformat:"s" %}selected{% endif %}>
          {{ u.get_full_name|default:u.username }}
        </option>
      {% endfor %}
    </select>
    <button class="btn btn-outline-secondary btn-sm" type="submit">Filtern</button>
  </form>
  {% endif %}

  <!-- Search bar -->
  <div class="mb-4">
    <input type="text" id="searchInput" class="form-control" placeholder="Patienten suchen..." onkeyup="filterPatients()">
  </div>

  <div class="row g-3" id="fallsContainer">
    <!-- Add new fall card -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <div class="card text-white bg-primary text-center" style="height: 180px; cursor: pointer;" onclick="loadNewFallModal()">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <div class="display-4">+</div>
          <div>Neuer Fall</div>
        </div>
      </div>
    </div>

    {% for patient in patients %}
    <div class="col-6 col-sm-4 col-md-3 col-lg-2 fall-card" data-patient-name="{{ patient.ptnName }} {{ patient.ptnLastname }}">
      <div class="card text-center position-relative" style="height: 180px;">
        {% if patient.usrID_id == request.user.id %}
          <a href="{% url 'patient_manage' patient.id %}" class="btn btn-light btn-sm gear-btn" title="Patient verwalten">
            <i class="fas fa-cog"></i>
          </a>
          <!-- Owner-only share shortcut: opens manage page with ?open=share -->

        {% endif %}

        <a href="{% url 'patientImage' patient.id %}" style="text-decoration: none; color: inherit;">
          {% if patient.thumbnail %}
            <img src="{{ patient.thumbnail.url }}" class="patient-thumb" alt="Thumbnail von {{ patient.ptnName }} {{ patient.ptnLastname }}">
          {% else %}    
            <div class="bg-info d-flex align-items-center justify-content-center" style="height:105px; border-top-left-radius:.25rem; border-top-right-radius:.25rem;">
              <img src="https://img.icons8.com/ios-filled/40/ffffff/task.png" alt="Case Icon">
            </div>
          {% endif %}
          <div class="card-body d-flex flex-column justify-content-center align-items-center p-2">
            <h6 class="fw-bold mb-0">
              {{ patient.ptnName }} {{ patient.ptnLastname }}
              {% if patient.visibility == 'PRIVATE' %}
                <span class="vis-badge vis-private" title="Nur Eigent√ºmer und Admins">Privat</span>
              {% elif patient.visibility == 'SHARED' %}
                <span class="vis-badge vis-shared" title="Mit ausgew√§hlten Nutzern geteilt">Geteilt</span>
              {% elif patient.visibility == 'PUBLIC_ORG' %}
                <span class="vis-badge vis-public" title="F√ºr alle angemeldeten Nutzer sichtbar">√ñffentlich</span>
              {% endif %}
            </h6>

            {% if patient.usrID_id == request.user.id %}
              <span class="badge bg-light text-dark mt-1">Eigent√ºmer</span>
            {% elif patient.shared_with.all|length and request.user in patient.shared_with.all %}
              <span class="badge bg-warning text-dark mt-1">Geteilt</span>
            {% else %}
              <span class="badge bg-secondary mt-1">Fremd</span>
            {% endif %}

            <!-- Chips per visibility rules -->
            {% if patient.visibility == 'PRIVATE' %}
              <!-- Only owner emoji -->
              <div class="chip-row">
                {% with owner_name=patient.usrID.get_full_name|default:patient.usrID.username %}
                  <div class="owner-chip" title="Eigent√ºmer: {{ owner_name }}">
                    {{ owner_name|slice:":1"|upper }}
                  </div>
                {% endwith %}
              </div>
            {% elif patient.visibility == 'SHARED' %}
              <!-- Only shared users' emojis -->
              {% with shared_list=patient.shared_with.all %}
                {% if shared_list|length > 0 %}
                <div class="chip-row">
                  {% for u in shared_list|slice:":5" %}
                    {% with un=u.get_full_name|default:u.username %}
                      <div class="owner-chip shared" title="Geteilt mit: {{ un }}">
                        {{ un|slice:":1"|upper }}
                      </div>
                    {% endwith %}
                  {% endfor %}
                  {% if shared_list|length > 5 %}
                    <div class="owner-chip more" title="Weitere geteilt: {{ shared_list|length|add:'-5' }}">‚Ä¶</div>
                  {% endif %}
                </div>
                {% endif %}
              {% endwith %}
            {% else %}
              <!-- PUBLIC_ORG: show no emojis -->
            {% endif %}
          </div>
        </a>

        {% if patient.usrID_id == request.user.id or request.user.is_staff or request.user.is_superuser %}
        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2"
                onclick="event.preventDefault(); confirmDelete({{ patient.id }}, this)">
          &times;
        </button>
        {% endif %}
      </div>
    </div>
    {% empty %}
      <p>Keine Patienten gefunden. Bitte f√ºgen Sie neue Patienten hinzu.</p>
    {% endfor %}
  </div>

  {% include 'newFall.html' %}
</div>

<button id="chat-toggle" title="Chat √∂ffnen">üí¨</button>

<script>
document.getElementById("chat-toggle").addEventListener("click", function() {
  document.getElementById("chat-box").classList.toggle("open");
});
function closeChatBox() {
  document.getElementById("chat-box").classList.remove("open");
}
function confirmDelete(patientId, buttonElement) {
  if (confirm("Sind Sie sicher, dass Sie diesen Patienten l√∂schen m√∂chten?")) {
    window.location.href = `/delete_patient/${patientId}/`;
  }
}
document.addEventListener('DOMContentLoaded', () => {
  let chatSocket = null, isSocketOpen = false, receiverId = null, unreadCount = 0;
  window.startChat = function(id, username) {
    if (receiverId === id) return;
    receiverId = id;
    document.getElementById('chat-with').textContent = username;
    document.getElementById('chat-messages').innerHTML = '';
    openChatBox(); connectWebSocket(); resetUnreadCount();
  };
  function openChatBox(){ document.getElementById('chat-box').style.display = 'flex'; }
  function closeChatBox(){ document.getElementById('chat-box').style.display = 'none'; }
  function connectWebSocket() {
    if (chatSocket) chatSocket.close();
    if (!receiverId) return;
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${protocol}://${window.location.host}/ws/chat/${receiverId}/`;
    chatSocket = new WebSocket(wsUrl);
    isSocketOpen = false;
    chatSocket.onopen = function(){ isSocketOpen = true; };
    chatSocket.onmessage = function(e){
      const data = JSON.parse(e.data);
      const message = data.message;
      const senderUsername = data.sender_username || 'Unknown';
      const senderIdMsg = data.sender_id;
      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML += `<div><strong>${senderUsername}:</strong> ${message}</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      if (senderIdMsg !== receiverId && document.getElementById('chat-box').style.display === 'none') {
        incrementUnreadCount();
      }
    };
    chatSocket.onclose = function(){ isSocketOpen = false; };
    chatSocket.onerror = function(){ isSocketOpen = false; };
  }
  window.sendMessage = function(){
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message || !chatSocket) return;
    if (isSocketOpen) {
      chatSocket.send(JSON.stringify({ 'message': message, 'receiver_id': receiverId }));
      input.value = '';
    }
  };
  function updateUnreadCount(count){
    unreadCount = count;
    const badge = document.getElementById('unread-count');
    if (unreadCount > 0){ badge.textContent = unreadCount; badge.style.display = 'inline-block'; }
    else { badge.style.display = 'none'; }
  }
  function incrementUnreadCount(){ unreadCount++; updateUnreadCount(unreadCount); }
  function resetUnreadCount(){ unreadCount = 0; updateUnreadCount(unreadCount); }
  window.openChatBox = openChatBox; window.closeChatBox = closeChatBox;
});
function filterPatients() {
  let input = document.getElementById("searchInput").value.toLowerCase();
  let cards = document.querySelectorAll("#fallsContainer .fall-card");
  cards.forEach(card => {
    let name = card.getAttribute("data-patient-name").toLowerCase();
    card.style.display = name.includes(input) ? "" : "none";
  });
}
</script>
{% endblock %}