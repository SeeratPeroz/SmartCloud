{% extends 'base.html' %}

{% block title %}Patient verwalten - CleverImplant{% endblock %}

{% block content %}

<style>
  /* ✅ Share modal: keep inside viewport + make body scroll */
  #shareModal .modal-dialog {
    height: calc(100vh - 2rem);
    margin: 1rem auto;
    max-width: 900px;          /* nicer on large screens */
    width: calc(100% - 1rem);  /* responsive */
  }

  #shareModal .modal-content {
    max-height: calc(100vh - 2rem);
  }

  #shareModal .modal-body {
    overflow-y: auto !important;
    /* header+footer height varies; keep enough room */
    max-height: calc(100vh - 12rem);
    padding-top: 0; /* because sticky header already has its own padding */
  }

  /* Fallback if any global CSS breaks modal scrolling */
  #shareModal.modal {
    overflow-y: auto !important;
  }

  /* ✅ Sticky search: stays on top AND content doesn't hide behind it */
  #shareModal .share-search-sticky {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #fff;
    padding: .75rem 1rem .75rem 1rem;
    border-bottom: 1px solid rgba(0,0,0,.08);
  }

  /* ✅ Create spacing so first rows never go under the sticky header */
  /* We set this dynamically in JS too, but this is a safe default */
  #shareModal .share-users-wrap {
    padding-top: .75rem;
  }

  /* ✅ Better list spacing / alignment */
  #shareModal .share-user-col {
    padding-left: .75rem;
    padding-right: .75rem;
  }

  #shareModal .share-user-item {
    padding: .45rem .5rem;
    border-radius: .6rem;
    display: flex;
    align-items: flex-start;
    gap: .5rem;
    min-width: 0; /* allows text ellipsis to work */
  }

  #shareModal .share-user-item:hover {
    background: rgba(0,0,0,.03);
  }

  /* ✅ Fix: checkbox pushes text too far left / overflow issues */
  #shareModal .share-user-item .form-check-input {
    margin-top: .25rem;
    flex: 0 0 auto;
  }

  #shareModal .share-user-item .form-check-label {
    margin: 0;
    padding-left: 0;
    flex: 1 1 auto;
    min-width: 0;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ✅ On mobile: one column and a bit more readable */
  @media (max-width: 576px) {
    #shareModal .modal-dialog {
      width: calc(100% - .5rem);
      margin: .25rem auto;
      height: calc(100vh - .5rem);
    }
    #shareModal .modal-content {
      max-height: calc(100vh - .5rem);
    }
    #shareModal .modal-body {
      max-height: calc(100vh - 10.5rem);
    }
    #shareModal .share-search-sticky {
      padding: .75rem .75rem .75rem .75rem;
    }
  }
</style>

<div class="container mt-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h4 mb-0">Patient verwalten</h2>
    <a href="{% url 'patientImage' patient.id %}" class="btn btn-outline-secondary btn-sm">Zurück zum Patientenbereich</a>
  </div>

  {% if not can_edit %}
    <div class="alert alert-warning">
      Sie haben nur Leserechte. Änderungen können nur vom Eigentümer/Manager vorgenommen werden.
    </div>
  {% endif %}

  <div class="row g-3">
    <!-- Details bearbeiten -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white"><strong>Details bearbeiten</strong></div>
        <div class="card-body">
          <form method="POST" action="{% url 'patient_manage' patient.id %}">
            {% csrf_token %}
            <input type="hidden" name="form" value="details">
            <div class="mb-3">
              <label class="form-label">Vorname</label>
              <input type="text" name="ptnName" class="form-control" value="{{ patient.ptnName }}" {% if not can_edit %}disabled{% endif %} required>
            </div>
            <div class="mb-3">
              <label class="form-label">Nachname</label>
              <input type="text" name="ptnLastname" class="form-control" value="{{ patient.ptnLastname }}" {% if not can_edit %}disabled{% endif %} required>
            </div>
            <div class="mb-3">
              <label class="form-label">Geburtsdatum</label>
              <input type="date" name="ptnDOB" class="form-control" value="{{ patient.ptnDOB|date:'Y-m-d' }}" {% if not can_edit %}disabled{% endif %} required>
            </div>
            {% if can_edit %}
            <button type="submit" class="btn btn-primary btn-sm">Speichern</button>
            {% endif %}
          </form>
        </div>
      </div>
    </div>

    <!-- Sichtbarkeit -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white"><strong>Sichtbarkeit</strong></div>
        <div class="card-body">
          <form id="visibilityForm" method="POST" action="{% url 'patient_manage' patient.id %}">
            {% csrf_token %}
            <input type="hidden" name="form" value="visibility">

            <div class="form-check">
              <input class="form-check-input" type="radio" name="visibility" id="vis_private" value="PRIVATE"
                     {% if patient.visibility == 'PRIVATE' %}checked{% endif %} {% if not can_edit %}disabled{% endif %}>
              <label class="form-check-label" for="vis_private">
                Privat <small class="text-muted d-block">Nur Eigentümer und Admin/Manager.</small>
              </label>
            </div>

            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="visibility" id="vis_shared" value="SHARED"
                     {% if patient.visibility == 'SHARED' %}checked{% endif %} {% if not can_edit %}disabled{% endif %}>
              <label class="form-check-label" for="vis_shared">
                Geteilt <small class="text-muted d-block">Wählen Sie Benutzer im nächsten Schritt aus.</small>
              </label>
            </div>

            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="visibility" id="vis_public" value="PUBLIC_ORG"
                     {% if patient.visibility == 'PUBLIC_ORG' %}checked{% endif %} {% if not can_edit %}disabled{% endif %}>
              <label class="form-check-label" for="vis_public">
                Öffentlich <small class="text-muted d-block">Für alle angemeldeten Nutzer sichtbar.</small>
              </label>
            </div>

            {% if can_edit %}
            <button id="btnSaveVisibility" type="submit" class="btn btn-primary btn-sm mt-3">Sichtbarkeit speichern</button>
            {% endif %}

            <div class="form-text mt-2">
              Hinweis: Bei <em>Geteilt</em> erscheint ein Dialog zum Auswählen der Benutzer.
            </div>
          </form>

          {% if patient.shared_with.all %}
          <hr>
          <div class="small text-muted">
            Aktuell geteilt mit:
            {% for u in patient.shared_with.all %}
              <span class="badge bg-light text-dark">{{ u.get_full_name|default:u.username }}</span>
            {% empty %}
              <span class="text-muted">Niemand</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Thumbnail hochladen -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white"><strong>Thumbnail</strong></div>
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-auto">
              {% if patient.thumbnail %}
                <img src="{{ patient.thumbnail.url }}" alt="Aktuelles Thumbnail" style="width:120px; height:80px; object-fit:cover; border-radius:6px;">
              {% else %}
                <div class="text-muted small">Kein Thumbnail hochgeladen.</div>
              {% endif %}
            </div>
            <div class="col">
              <form method="POST" enctype="multipart/form-data" action="{% url 'patient_manage' patient.id %}">
                {% csrf_token %}
                <input type="hidden" name="form" value="thumb">
                <div class="mb-2">
                  <input type="file" name="thumbnail" accept="image/*" class="form-control" {% if not can_edit %}disabled{% endif %} required>
                </div>
                {% if can_edit %}
                <button type="submit" class="btn btn-success btn-sm">Thumbnail hochladen/ersetzen</button>
                {% endif %}
              </form>

              {% if patient.thumbnail and can_edit %}
              <form method="POST" class="mt-2" action="{% url 'patient_manage' patient.id %}">
                {% csrf_token %}
                <input type="hidden" name="form" value="thumb_remove">
                <button type="submit" class="btn btn-outline-danger btn-sm">Thumbnail entfernen</button>
              </form>
              {% endif %}
            </div>
          </div>
          <div class="form-text mt-2">Empfohlen: Querformat ~ 4:3, max. 1–2 MB.</div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if can_edit %}
<!-- SHARE MODAL -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <form id="shareForm" method="POST" action="{% url 'patient_manage' patient.id %}">
        {% csrf_token %}
        <input type="hidden" name="form" value="set_shared">

        <div class="modal-header">
          <h5 class="modal-title" id="shareModalLabel">Benutzer auswählen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>

        <div class="modal-body">
          <!-- ✅ Sticky search + quick actions -->
          <div class="share-search-sticky" id="shareStickyHeader">
            <div class="text-muted mb-2">Wählen Sie die Benutzer aus, mit denen der Patient geteilt werden soll.</div>

            <input id="shareSearchInput" type="text" class="form-control"
                   placeholder="Suchen (Name / Username) …">

            <div class="d-flex flex-wrap gap-2 mt-2 align-items-center">
              <button type="button" id="shareSelectAllVisible" class="btn btn-outline-secondary btn-sm">
                Alle sichtbaren auswählen
              </button>
              <button type="button" id="shareClearAll" class="btn btn-outline-secondary btn-sm">
                Auswahl löschen
              </button>

              <div class="ms-sm-auto small text-muted">
                <span id="shareVisibleCount">0</span> sichtbar
              </div>
            </div>
          </div>

          <!-- ✅ users list wrapper (we add top-padding dynamically = sticky header height) -->
          <div class="share-users-wrap" id="shareUsersWrap">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-2 mt-0" id="shareUsersGrid">
              {% for u in users %}
                {% if u.id != patient.usrID.id %}
                <div class="col share-user-col"
                     data-share-text="{{ u.get_full_name|default:u.username|lower }} {{ u.username|lower }}">
                  <div class="form-check share-user-item" style="padding-left: 20px;">
                    <input class="form-check-input" type="checkbox" id="share_{{ u.id }}"
                           name="share_with" value="{{ u.id }}"
                           {% if u in patient.shared_with.all %}checked{% endif %}>
                    <label class="form-check-label" for="share_{{ u.id }}">
                      {{ u.get_full_name|default:u.username }}
                      {% if u.get_full_name %}<span class="text-muted">({{ u.username }})</span>{% endif %}
                    </label>
                  </div>
                </div>
                {% endif %}
              {% endfor %}
            </div>

            <div id="shareNoResults" class="text-muted small mt-3 d-none">
              Keine Benutzer gefunden.
            </div>

            <div id="shareError" class="alert alert-danger d-none mt-3" role="alert">
              Bitte wählen Sie mindestens einen Benutzer aus.
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
          <button id="shareOkBtn" type="submit" class="btn btn-primary">OK</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const visPrivate = document.getElementById('vis_private');
  const visShared  = document.getElementById('vis_shared');
  const visPublic  = document.getElementById('vis_public');
  const visForm    = document.getElementById('visibilityForm');
  const shareModalEl = document.getElementById('shareModal');

  let previousVis = (document.querySelector('input[name="visibility"]:checked') || {}).value;

  function getModalInstance(el){
    if (!el) return null;
    if (window.bootstrap?.Modal) return bootstrap.Modal.getOrCreateInstance(el);
    if (window.jQuery && typeof jQuery(el).modal === 'function') return { show: ()=>jQuery(el).modal('show'), hide: ()=>jQuery(el).modal('hide') };
    return null;
  }
  function openShareModal(){ getModalInstance(shareModalEl)?.show(); }

  // Intercept radio changes:
  visPrivate?.addEventListener('change', function(e){
    if (!e.target.checked) return;
    if (!confirm('Alle bestehenden Freigaben werden entfernt. Fortfahren?')) {
      if (previousVis === 'SHARED') visShared.checked = true;
      else if (previousVis === 'PUBLIC_ORG') visPublic.checked = true;
      else visPublic.checked = true;
      return;
    }
    previousVis = 'PRIVATE';
    visForm?.submit();
  });

  visShared?.addEventListener('change', function(e){
    if (!e.target.checked) return;
    openShareModal();
  });

  visPublic?.addEventListener('change', function(e){
    if (!e.target.checked) return;
    previousVis = 'PUBLIC_ORG';
    visForm?.submit();
  });

  // If modal is closed without submitting, revert radio to previous selection
  if (shareModalEl){
    shareModalEl.addEventListener('hidden.bs.modal', function(){
      const checked = document.querySelector('input[name="visibility"]:checked');
      if (checked && checked.value === 'SHARED') {
        if (previousVis === 'PRIVATE') visPrivate.checked = true;
        else if (previousVis === 'PUBLIC_ORG') visPublic.checked = true;
        else visPrivate.checked = true;
      }
    });
  }

  // ✅ Share search + selection helpers
  const shareForm = document.getElementById('shareForm');
  const shareError = document.getElementById('shareError');
  const searchInput = document.getElementById('shareSearchInput');
  const grid = document.getElementById('shareUsersGrid');
  const noResults = document.getElementById('shareNoResults');
  const visibleCountEl = document.getElementById('shareVisibleCount');
  const btnSelectAllVisible = document.getElementById('shareSelectAllVisible');
  const btnClearAll = document.getElementById('shareClearAll');

  const stickyHeader = document.getElementById('shareStickyHeader');
  const usersWrap = document.getElementById('shareUsersWrap');

  function updateStickyOffset(){
    if (!stickyHeader || !usersWrap) return;
    const h = stickyHeader.offsetHeight || 0;
    usersWrap.style.paddingTop = (h + 8) + 'px'; // ✅ ensures content never goes behind sticky
  }

  function updateVisibleCount(){
    if (!grid || !visibleCountEl) return;
    const cols = grid.querySelectorAll('.share-user-col');
    let visible = 0;
    cols.forEach(col => {
      if (!col.classList.contains('d-none')) visible++;
    });
    visibleCountEl.textContent = String(visible);
    if (noResults){
      noResults.classList.toggle('d-none', visible !== 0);
    }
  }

  function filterUsers(){
    if (!grid) return;
    const q = (searchInput?.value || '').trim().toLowerCase();
    const cols = grid.querySelectorAll('.share-user-col');
    cols.forEach(col => {
      const text = (col.getAttribute('data-share-text') || '');
      const match = !q || text.includes(q);
      col.classList.toggle('d-none', !match);
    });
    updateVisibleCount();
  }

  searchInput?.addEventListener('input', filterUsers);

  btnSelectAllVisible?.addEventListener('click', function(){
    if (!grid) return;
    const cols = grid.querySelectorAll('.share-user-col:not(.d-none)');
    cols.forEach(col => {
      const cb = col.querySelector('input[name="share_with"]');
      if (cb) cb.checked = true;
    });
  });

  btnClearAll?.addEventListener('click', function(){
    if (!grid) return;
    const cbs = grid.querySelectorAll('input[name="share_with"]');
    cbs.forEach(cb => cb.checked = false);
  });

  // When modal opens, focus search and refresh counts + sticky offset
  shareModalEl?.addEventListener('shown.bs.modal', function(){
    updateStickyOffset();
    updateVisibleCount();
    setTimeout(() => searchInput?.focus(), 150);
  });

  // Recalculate on resize/orientation change
  window.addEventListener('resize', function(){
    updateStickyOffset();
  });

  // Validate at least one user before submitting the share form
  shareForm?.addEventListener('submit', function(e){
    const anyChecked = !!shareForm.querySelector('input[name="share_with"]:checked');
    if (!anyChecked){
      e.preventDefault();
      shareError?.classList.remove('d-none');
      return false;
    }
    shareError?.classList.add('d-none');
    previousVis = 'SHARED';
  });

  // Support ?open=share from index shortcut
  const params = new URLSearchParams(window.location.search);
  if (params.get('open') === 'share' && visShared) {
    visShared.checked = true;
    previousVis = (document.querySelector('input[name="visibility"]:checked') || {}).value;
    openShareModal();
  }

  // Initialize once
  updateStickyOffset();
  updateVisibleCount();
});
</script>

{% endblock %}
